<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单词情境学习</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #5b6bf0;
            --secondary: #6c7df6;
            --accent: #ff7b7b;
            --light: #f8faff;
            --dark: #2c3e50;
            --success: #4cd964;
            --warning: #ffcc00;
            --info: #5ac8fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
        }
        
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }
        
        .exit-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .exit-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            min-height: 500px;
            padding: 20px;
        }
        
        .upload-section, .preview-section, .story-section, .quiz-section, .results-section, .analysis-section {
            padding: 20px;
            display: none;
        }
        
        .active-section {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: 15px;
            padding: 50px 20px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(91, 107, 240, 0.05);
        }
        
        .upload-area:hover {
            background-color: rgba(91, 107, 240, 0.1);
            transform: translateY(-5px);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .story-part {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 15px;
            background-color: var(--light);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            border-left: 5px solid var(--primary);
        }
        
        .story-image-container {
            position: relative;
            width: 100%;
            height: 300px;
            border-radius: 12px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .story-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        
        .story-image:hover {
            transform: scale(1.05);
        }
        
        .story-text {
            line-height: 1.7;
            font-size: 1.15rem;
            margin-bottom: 15px;
        }
        
        .word-card {
            display: inline-block;
            background: linear-gradient(135deg, var(--warning), #ffdb4d);
            padding: 6px 12px;
            border-radius: 8px;
            margin: 5px;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .word-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .word-card .chinese {
            font-size: 0.85rem;
            font-weight: normal;
            margin-left: 5px;
            color: #666;
        }
        
        .quiz-question {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 12px;
            background-color: var(--light);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .question-text {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .option {
            padding: 15px 18px;
            border: 2px solid #e1e5f1;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option:hover {
            background-color: #f0f2ff;
            border-color: var(--primary);
        }
        
        .option.selected {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.02);
        }
        
        .option-letter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-weight: bold;
        }
        
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }
        
        button {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-secondary {
            background-color: #f0f2ff;
            color: var(--primary);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #34c759);
            color: white;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin: 25px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.5s;
            border-radius: 5px;
        }
        
        .celebration {
            text-align: center;
            padding: 25px;
            animation: celebrate 0.5s ease-in-out;
            background: linear-gradient(135deg, rgba(76, 217, 100, 0.1), rgba(90, 200, 250, 0.1));
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .celebration-animation {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: bounce 1s infinite;
        }
        
        .celebration-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--success);
        }
        
        .encouragement {
            text-align: center;
            padding: 25px;
            animation: fadeIn 0.5s ease-in-out;
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.1), rgba(255, 123, 123, 0.1));
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .encouragement-animation {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        
        .encouragement-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--warning);
        }
        
        .results-container {
            text-align: center;
            padding: 40px 30px;
        }
        
        .score {
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 20px 0;
        }
        
        .feedback {
            font-size: 1.3rem;
            margin-bottom: 30px;
            color: var(--dark);
        }
        
        .word-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 25px 0;
            justify-content: center;
        }
        
        .timer {
            text-align: center;
            font-size: 1.2rem;
            margin: 15px 0;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .time-bar {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .time-left {
            height: 100%;
            background: linear-gradient(135deg, var(--accent), #ff5252);
            width: 100%;
            border-radius: 4px;
            transition: width 1s linear;
        }
        
        .image-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: linear-gradient(135deg, #f0f2ff, #e1e5f1);
            color: var(--primary);
            font-weight: 600;
        }
        
        .audio-control {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .audio-control:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
        }
        
        .analysis-container {
            padding: 20px;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .analysis-card {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .analysis-card h3 {
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .analysis-card ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .analysis-card li {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
        }
        
        .analysis-card li:last-child {
            border-bottom: none;
        }
        
        .word-status {
            font-weight: bold;
        }
        
        .word-status.correct {
            color: var(--success);
        }
        
        .word-status.incorrect {
            color: var(--accent);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .recommendations {
            margin-top: 20px;
            padding: 15px;
            background: rgba(91, 107, 240, 0.05);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .recommendations h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        @keyframes celebrate {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .buttons {
                flex-direction: column;
                gap: 12px;
            }
            
            button {
                width: 100%;
            }
            
            .story-image-container {
                height: 200px;
            }
            
            .audio-control {
                top: 15px;
                left: 15px;
                width: 40px;
                height: 40px;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="audio-control" id="audioControl" title="音效开关">
                <i class="fas fa-volume-up"></i>
            </button>
            <h1>单词情境学习</h1>
            <div class="subtitle">在精美故事中轻松记忆单词</div>
            <button class="exit-btn" id="exitBtn" style="display: none;">
                <i class="fas fa-sign-out-alt"></i>
                退出学习
            </button>
        </header>
        
        <div class="main-content">
            <!-- 上传单词部分 -->
            <section id="uploadSection" class="upload-section active-section">
                <h2>上传单词列表</h2>
                <p>请上传包含您想学习的单词的文本文件（每行一个单词）</p>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-file-upload"></i>
                    </div>
                    <h3>点击上传单词文件</h3>
                    <p>或拖放文件到此处</p>
                    <input type="file" id="fileInput" accept=".txt" style="display: none;">
                </div>
                
                <div class="buttons">
                    <button id="demoBtn" class="btn-secondary">
                        <i class="fas fa-magic"></i>
                        使用示例单词
                    </button>
                </div>
            </section>
            
            <!-- 单词预览部分 -->
            <section id="previewSection" class="preview-section">
                <h2>学习单词预览</h2>
                <p>以下是您将要学习的单词，我们将在故事中反复遇到它们：</p>
                
                <div class="word-list" id="wordList"></div>
                
                <div class="buttons">
                    <button id="backToUploadBtn" class="btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        返回上传
                    </button>
                    <button id="startLearningBtn" class="btn-primary">
                        <i class="fas fa-play"></i>
                        开始学习
                    </button>
                </div>
            </section>
            
            <!-- 故事学习部分 -->
            <section id="storySection" class="story-section">
                <h2>故事学习</h2>
                <div class="progress-bar">
                    <div class="progress" id="storyProgress"></div>
                </div>
                
                <div id="storyParts"></div>
                
                <div class="buttons">
                    <button id="prevPartBtn" class="btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        上一部分
                    </button>
                    <button id="nextPartBtn" class="btn-primary">
                        <i class="fas fa-arrow-right"></i>
                        下一部分
                    </button>
                    <button id="startQuizBtn" class="btn-success" style="display: none;">
                        <i class="fas fa-question-circle"></i>
                        开始测试
                    </button>
                </div>
            </section>
            
            <!-- 测试部分 -->
            <section id="quizSection" class="quiz-section">
                <h2>单词测试</h2>
                <div class="progress-bar">
                    <div class="progress" id="quizProgress"></div>
                </div>
                
                <div class="timer">
                    <i class="fas fa-clock"></i>
                    剩余时间: <span id="timeLeft">60</span>秒
                    <div class="time-bar">
                        <div class="time-left" id="timeBar"></div>
                    </div>
                </div>
                
                <div id="quizQuestions"></div>
                
                <div class="buttons">
                    <button id="prevQuestionBtn" class="btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        上一题
                    </button>
                    <button id="nextQuestionBtn" class="btn-primary">
                        <i class="fas fa-arrow-right"></i>
                        下一题
                    </button>
                    <button id="submitQuizBtn" class="btn-success" style="display: none;">
                        <i class="fas fa-paper-plane"></i>
                        提交答案
                    </button>
                </div>
                
                <div id="celebrationContainer" class="celebration" style="display: none;"></div>
                <div id="encouragementContainer" class="encouragement" style="display: none;"></div>
            </section>
            
            <!-- 结果部分 -->
            <section id="resultsSection" class="results-section">
                <div class="results-container">
                    <h2>学习成果</h2>
                    <div class="score" id="finalScore">0/0</div>
                    <div class="feedback" id="resultFeedback"></div>
                    
                    <div class="buttons">
                        <button id="analysisBtn" class="btn-primary">
                            <i class="fas fa-chart-line"></i>
                            查看学情分析
                        </button>
                        <button id="restartBtn" class="btn-secondary">
                            <i class="fas fa-redo"></i>
                            重新开始
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- 学情分析部分 -->
            <section id="analysisSection" class="analysis-section">
                <div class="analysis-container">
                    <h2>学情分析报告</h2>
                    <p>基于您的学习表现，我们为您生成了一份详细的分析报告</p>
                    
                    <div class="analysis-grid">
                        <div class="analysis-card">
                            <h3><i class="fas fa-check-circle"></i> 单词掌握情况</h3>
                            <ul id="wordMasteryList"></ul>
                        </div>
                        
                        <div class="analysis-card">
                            <h3><i class="fas fa-chart-bar"></i> 学习数据统计</h3>
                            <div class="stats-grid" id="statsGrid"></div>
                        </div>
                        
                        <div class="analysis-card">
                            <h3><i class="fas fa-lightbulb"></i> 学习建议</h3>
                            <div class="recommendations" id="recommendations"></div>
                        </div>
                    </div>
                    
                    <div class="buttons">
                        <button id="backToResultsBtn" class="btn-secondary">
                            <i class="fas fa-arrow-left"></i>
                            返回结果
                        </button>
                        <button id="newSessionBtn" class="btn-primary">
                            <i class="fas fa-plus-circle"></i>
                            新的学习
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // 应用状态
        const appState = {
            currentSection: 'upload',
            targetWords: [],
            wordDefinitions: {},
            storyParts: [],
            currentPart: 0,
            quizQuestions: [],
            currentQuestion: 0,
            userAnswers: [],
            score: 0,
            timeLeft: 60,
            timerInterval: null,
            audioEnabled: true,
            startTime: null,
            endTime: null,
            wordPerformance: {}
        };

        // DOM元素
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const storySection = document.getElementById('storySection');
        const quizSection = document.getElementById('quizSection');
        const resultsSection = document.getElementById('resultsSection');
        const analysisSection = document.getElementById('analysisSection');
        
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const demoBtn = document.getElementById('demoBtn');
        const wordList = document.getElementById('wordList');
        const backToUploadBtn = document.getElementById('backToUploadBtn');
        const startLearningBtn = document.getElementById('startLearningBtn');
        
        const exitBtn = document.getElementById('exitBtn');
        const audioControl = document.getElementById('audioControl');
        
        const storyPartsContainer = document.getElementById('storyParts');
        const prevPartBtn = document.getElementById('prevPartBtn');
        const nextPartBtn = document.getElementById('nextPartBtn');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const storyProgress = document.getElementById('storyProgress');
        
        const quizQuestionsContainer = document.getElementById('quizQuestions');
        const prevQuestionBtn = document.getElementById('prevQuestionBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const submitQuizBtn = document.getElementById('submitQuizBtn');
        const quizProgress = document.getElementById('quizProgress');
        const celebrationContainer = document.getElementById('celebrationContainer');
        const encouragementContainer = document.getElementById('encouragementContainer');
        const timeLeftDisplay = document.getElementById('timeLeft');
        const timeBar = document.getElementById('timeBar');
        
        const finalScore = document.getElementById('finalScore');
        const resultFeedback = document.getElementById('resultFeedback');
        const analysisBtn = document.getElementById('analysisBtn');
        const restartBtn = document.getElementById('restartBtn');
        const backToResultsBtn = document.getElementById('backToResultsBtn');
        const newSessionBtn = document.getElementById('newSessionBtn');
        
        const wordMasteryList = document.getElementById('wordMasteryList');
        const statsGrid = document.getElementById('statsGrid');
        const recommendations = document.getElementById('recommendations');

        // 示例单词和定义
        const demoWords = [
            {word: 'explore', meaning: '探索', pos: 'v.', chinese: '探索'},
            {word: 'brave', meaning: '勇敢的', pos: 'adj.', chinese: '勇敢的'},
            {word: 'discovery', meaning: '发现', pos: 'n.', chinese: '发现'},
            {word: 'challenge', meaning: '挑战', pos: 'n.', chinese: '挑战'},
            {word: 'treasure', meaning: '宝藏', pos: 'n.', chinese: '宝藏'},
            {word: 'journey', meaning: '旅程', pos: 'n.', chinese: '旅程'},
            {word: 'mysterious', meaning: '神秘的', pos: 'adj.', chinese: '神秘的'},
            {word: 'adventure', meaning: '冒险', pos: 'n.', chinese: '冒险'}
        ];

        // 单词定义词典
        const wordDictionary = {
            'explore': {meaning: '探索', pos: 'v.', chinese: '探索'},
            'brave': {meaning: '勇敢的', pos: 'adj.', chinese: '勇敢的'},
            'discovery': {meaning: '发现', pos: 'n.', chinese: '发现'},
            'challenge': {meaning: '挑战', pos: 'n.', chinese: '挑战'},
            'treasure': {meaning: '宝藏', pos: 'n.', chinese: '宝藏'},
            'journey': {meaning: '旅程', pos: 'n.', chinese: '旅程'},
            'mysterious': {meaning: '神秘的', pos: 'adj.', chinese: '神秘的'},
            'adventure': {meaning: '冒险', pos: 'n.', chinese: '冒险'},
            'research': {meaning: '研究', pos: 'n./v.', chinese: '研究'},
            'patient': {meaning: '耐心的', pos: 'adj.', chinese: '耐心的'},
            'difficulty': {meaning: '困难', pos: 'n.', chinese: '困难'},
            'knowledge': {meaning: '知识', pos: 'n.', chinese: '知识'},
            'wisdom': {meaning: '智慧', pos: 'n.', chinese: '智慧'},
            'persistence': {meaning: '坚持', pos: 'n.', chinese: '坚持'},
            'answer': {meaning: '答案', pos: 'n.', chinese: '答案'},
            'insight': {meaning: '见解', pos: 'n.', chinese: '见解'}
        };

        // 故事图片 - 使用高质量外部图片链接
        const storyImages = [
            "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80", // 山脉
            "https://images.unsplash.com/photo-1506260408121-e353d10b87c7?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80", // 森林
            "https://images.unsplash.com/photo-1539650116574-75c0c6d73f6e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80", // 宝藏
            "https://images.unsplash.com/photo-1533227268428-f9ed0900fb3b?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80",  // 成功
            "https://images.unsplash.com/photo-1551632811-561732d1e306?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80", // 冒险
            "https://images.unsplash.com/photo-1483728642387-6c3bdd6c93e5?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80", // 风景
            "https://images.unsplash.com/photo-1469474968028-56623f02e42e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80", // 自然
            "https://images.unsplash.com/photo-1501854140801-50d01698950b?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80"  // 日出
        ];

        // 音效函数
        function playSound(type) {
            if (!appState.audioEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'correct') {
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                } else if (type === 'celebration') {
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime); // E5
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 1);
                } else if (type === 'encouragement') {
                    oscillator.frequency.setValueAtTime(392.00, audioContext.currentTime); // G4
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                } else if (type === 'complete') {
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                } else if (type === 'click') {
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                } else if (type === 'page') {
                    oscillator.frequency.setValueAtTime(349.23, audioContext.currentTime); // F4
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                }
            } catch (e) {
                console.log("音频上下文不支持");
            }
        }

        // 初始化应用
        function initApp() {
            // 事件监听器
            uploadArea.addEventListener('click', () => {
                fileInput.click();
                playSound('click');
            });
            fileInput.addEventListener('change', handleFileUpload);
            demoBtn.addEventListener('click', useDemoWords);
            
            backToUploadBtn.addEventListener('click', () => {
                showSection('upload');
                playSound('click');
            });
            startLearningBtn.addEventListener('click', startLearning);
            
            exitBtn.addEventListener('click', exitLearning);
            audioControl.addEventListener('click', toggleAudio);
            
            prevPartBtn.addEventListener('click', showPreviousPart);
            nextPartBtn.addEventListener('click', showNextPart);
            startQuizBtn.addEventListener('click', startQuiz);
            
            prevQuestionBtn.addEventListener('click', showPreviousQuestion);
            nextQuestionBtn.addEventListener('click', showNextQuestion);
            submitQuizBtn.addEventListener('click', submitQuiz);
            
            analysisBtn.addEventListener('click', showAnalysis);
            backToResultsBtn.addEventListener('click', () => showSection('results'));
            newSessionBtn.addEventListener('click', restartApp);
            restartBtn.addEventListener('click', restartApp);
            
            // 初始化拖放功能
            initDragAndDrop();
        }

        // 切换音效
        function toggleAudio() {
            appState.audioEnabled = !appState.audioEnabled;
            const icon = audioControl.querySelector('i');
            if (appState.audioEnabled) {
                icon.className = 'fas fa-volume-up';
                audioControl.title = '关闭音效';
                playSound('click');
            } else {
                icon.className = 'fas fa-volume-mute';
                audioControl.title = '开启音效';
            }
        }

        // 初始化拖放功能
        function initDragAndDrop() {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = 'rgba(91, 107, 240, 0.1)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.backgroundColor = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload();
                }
            });
        }

        // 处理文件上传
        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                processWordList(content);
            };
            reader.readAsText(file);
        }

        // 使用示例单词
        function useDemoWords() {
            appState.targetWords = demoWords.map(item => item.word);
            appState.wordDefinitions = {};
            
            demoWords.forEach(item => {
                appState.wordDefinitions[item.word] = {
                    meaning: item.meaning,
                    pos: item.pos,
                    chinese: item.chinese
                };
            });
            
            showWordPreview();
            playSound('page');
        }

        // 处理单词列表
        function processWordList(content) {
            if (content) {
                // 从文件内容提取单词
                const words = content.split('\n')
                    .map(word => word.trim().toLowerCase())
                    .filter(word => word.length > 0);
                appState.targetWords = words;
                
                // 获取单词定义
                appState.wordDefinitions = {};
                words.forEach(word => {
                    if (wordDictionary[word]) {
                        appState.wordDefinitions[word] = wordDictionary[word];
                    } else {
                        // 如果单词不在词典中，使用默认值
                        appState.wordDefinitions[word] = {
                            meaning: `definition of ${word}`,
                            pos: 'unknown',
                            chinese: `${word}的中文意思`
                        };
                    }
                });
            }
            
            if (appState.targetWords.length === 0) {
                alert('未找到有效单词，请检查文件格式');
                return;
            }
            
            showWordPreview();
            playSound('page');
        }

        // 显示单词预览
        function showWordPreview() {
            wordList.innerHTML = '';
            
            appState.targetWords.forEach(word => {
                const definition = appState.wordDefinitions[word];
                const wordElement = document.createElement('div');
                wordElement.className = 'word-card';
                wordElement.innerHTML = `
                    ${word} <span class="chinese">${definition.chinese} (${definition.pos})</span>
                `;
                wordList.appendChild(wordElement);
            });
            
            showSection('preview');
        }

        // 开始学习
        function startLearning() {
            // 记录开始时间
            appState.startTime = new Date();
            
            // 生成故事和测试
            generateStory();
            generateQuiz();
            
            // 切换到故事部分
            showSection('story');
            showStoryPart(0);
            
            // 显示退出按钮
            exitBtn.style.display = 'flex';
            
            playSound('page');
        }

        // 生成故事
        function generateStory() {
            const words = appState.targetWords;
            
            // 故事模板
            const storyTemplates = [
                {
                    title: "神秘岛探险",
                    parts: [
                        `年轻的探险家艾利克斯决定${words[0] || 'explore'}一个偏远的岛屿。艾利克斯以${words[1] || 'brave'}著称，总是寻求新的${words[2] || 'discovery'}。`,
                        `在旅途中，艾利克斯遇到了许多${words[3] || 'challenge'}。尽管有这些障碍，艾利克斯仍然保持${words[1] || 'brave'}，继续${words[0] || 'explore'}。`,
                        `最激动人心的时刻是当艾利克斯发现了一个古老的${words[4] || 'treasure'}。这个${words[4] || 'treasure'}包含了关于${words[2] || 'discovery'}的秘密，将改变一切。`,
                        `最终，艾利克斯的${words[1] || 'brave'}态度和愿意${words[0] || 'explore'}的精神带来了巨大的${words[5] || 'success'}。${words[3] || 'challenge'}被克服了，${words[2] || 'discovery'}终于被理解了。`
                    ]
                },
                {
                    title: "失落的文明",
                    parts: [
                        `考古学家萨拉开始${words[0] || 'research'}一个${words[6] || 'mysterious'}的古代文明。她的${words[1] || 'patient'}使她能够做出重大${words[2] || 'discovery'}。`,
                        `萨拉面临许多${words[3] || 'difficulty'}，但她的${words[1] || 'persistence'}从未动摇。她继续${words[0] || 'research'}，寻找${words[4] || 'answer'}。`,
                        `在一个${words[6] || 'mysterious'}的洞穴中，萨拉发现了失落的${words[4] || 'knowledge'}。这一${words[2] || 'discovery'}揭示了古代${words[7] || 'wisdom'}的秘密。`,
                        `萨拉的${words[1] || 'persistence'}得到了回报，她不仅解开了${words[6] || 'mystery'}，还获得了宝贵的${words[4] || 'insight'}，为未来的${words[0] || 'research'}铺平了道路。`
                    ]
                }
            ];
            
            // 随机选择一个故事模板
            const template = storyTemplates[Math.floor(Math.random() * storyTemplates.length)];
            appState.storyParts = template.parts;
        }

        // 生成测试
        function generateQuiz() {
            const words = appState.targetWords;
            appState.quizQuestions = [];
            
            // 为每个单词生成选择题
            words.forEach(word => {
                appState.quizQuestions.push({
                    type: 'multiple_choice',
                    question: `"${word}" 的意思是什么？`,
                    options: generateOptions(word),
                    correctAnswer: appState.wordDefinitions[word].chinese,
                    word: word
                });
            });
            
            // 初始化用户答案数组
            appState.userAnswers = new Array(appState.quizQuestions.length).fill('');
        }

        // 生成选择题选项
        function generateOptions(word) {
            const correct = appState.wordDefinitions[word].chinese;
            const otherWords = appState.targetWords.filter(w => w !== word);
            const wrongOptions = [];
            
            // 随机选择3个错误选项
            while (wrongOptions.length < 3 && otherWords.length > 0) {
                const randomWord = otherWords[Math.floor(Math.random() * otherWords.length)];
                const wrongDef = appState.wordDefinitions[randomWord].chinese;
                if (!wrongOptions.includes(wrongDef)) {
                    wrongOptions.push(wrongDef);
                }
            }
            
            // 如果错误选项不足，添加通用错误选项
            while (wrongOptions.length < 3) {
                wrongOptions.push('不正确的选项');
            }
            
            const options = [correct, ...wrongOptions];
            return shuffleArray(options);
        }

        // 显示指定部分
        function showSection(section) {
            // 隐藏所有部分
            uploadSection.classList.remove('active-section');
            previewSection.classList.remove('active-section');
            storySection.classList.remove('active-section');
            quizSection.classList.remove('active-section');
            resultsSection.classList.remove('active-section');
            analysisSection.classList.remove('active-section');
            
            // 显示指定部分
            document.getElementById(section + 'Section').classList.add('active-section');
            appState.currentSection = section;
        }

        // 显示故事部分
        function showStoryPart(partIndex) {
            appState.currentPart = partIndex;
            storyPartsContainer.innerHTML = '';
            
            // 显示当前部分
            const partElement = document.createElement('div');
            partElement.className = 'story-part';
            
            // 使用外部图片 - 随机选择一张图片
            const randomImageIndex = Math.floor(Math.random() * storyImages.length);
            const imageUrl = storyImages[randomImageIndex];
            
            partElement.innerHTML = `
                <h3>第 ${partIndex + 1} 部分</h3>
                <div class="story-image-container">
                    <div class="image-loading">图片加载中...</div>
                    <img src="${imageUrl}" alt="故事插图" class="story-image" style="display: none;" onload="handleImageLoad(this)">
                </div>
                <p class="story-text">${formatStoryText(appState.storyParts[partIndex], partIndex)}</p>
            `;
            
            storyPartsContainer.appendChild(partElement);
            
            // 更新进度条
            const progress = ((partIndex + 1) / appState.storyParts.length) * 100;
            storyProgress.style.width = `${progress}%`;
            
            // 更新按钮状态
            prevPartBtn.style.display = partIndex > 0 ? 'flex' : 'none';
            
            if (partIndex < appState.storyParts.length - 1) {
                nextPartBtn.style.display = 'flex';
                startQuizBtn.style.display = 'none';
            } else {
                nextPartBtn.style.display = 'none';
                startQuizBtn.style.display = 'flex';
            }
        }

        // 图片加载处理
        function handleImageLoad(img) {
            img.style.display = 'block';
            const container = img.parentElement;
            const loadingElement = container.querySelector('.image-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }

        // 格式化故事文本
        function formatStoryText(text, partIndex) {
            let formattedText = text;
            
            // 替换目标单词
            appState.targetWords.forEach(word => {
                const regex = new RegExp(word, 'gi');
                const definition = appState.wordDefinitions[word];
                
                // 第一部分显示中文意思，其他部分只显示英文
                if (partIndex === 0) {
                    formattedText = formattedText.replace(regex, 
                        `<span class="word-card">${word} <span class="chinese">${definition.chinese}</span></span>`);
                } else {
                    formattedText = formattedText.replace(regex, 
                        `<span class="word-card">${word}</span>`);
                }
            });
            
            return formattedText;
        }

        // 显示上一部分
        function showPreviousPart() {
            if (appState.currentPart > 0) {
                showStoryPart(appState.currentPart - 1);
                playSound('page');
            }
        }

        // 显示下一部分
        function showNextPart() {
            if (appState.currentPart < appState.storyParts.length - 1) {
                showStoryPart(appState.currentPart + 1);
                playSound('page');
            }
        }

        // 开始测试
        function startQuiz() {
            showSection('quiz');
            startTimer();
            showQuestion(0);
            playSound('page');
        }

        // 开始计时器
        function startTimer() {
            appState.timeLeft = 60;
            timeLeftDisplay.textContent = appState.timeLeft;
            timeBar.style.width = '100%';
            
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
            }
            
            appState.timerInterval = setInterval(() => {
                appState.timeLeft--;
                timeLeftDisplay.textContent = appState.timeLeft;
                timeBar.style.width = `${(appState.timeLeft / 60) * 100}%`;
                
                if (appState.timeLeft <= 0) {
                    clearInterval(appState.timerInterval);
                    submitQuiz();
                }
            }, 1000);
        }

        // 显示测试问题
        function showQuestion(questionIndex) {
            appState.currentQuestion = questionIndex;
            quizQuestionsContainer.innerHTML = '';
            
            const question = appState.quizQuestions[questionIndex];
            const questionElement = document.createElement('div');
            questionElement.className = 'quiz-question';
            
            questionElement.innerHTML = `
                <div class="question-text">${question.question}</div>
                <div class="options" id="optionsContainer">
                    ${question.options.map((option, index) => `
                        <div class="option ${appState.userAnswers[questionIndex] === option ? 'selected' : ''}" 
                             data-value="${option}">
                             <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                             ${option}
                        </div>
                    `).join('')}
                </div>
            `;
            
            // 添加选项点击事件
            const options = questionElement.querySelectorAll('.option');
            options.forEach(option => {
                option.addEventListener('click', () => {
                    // 取消其他选项的选择
                    options.forEach(opt => opt.classList.remove('selected'));
                    // 选择当前选项
                    option.classList.add('selected');
                    // 保存答案
                    appState.userAnswers[questionIndex] = option.dataset.value;
                    
                    // 显示反馈（如果答案正确显示庆祝，错误显示鼓励）
                    if (option.dataset.value === question.correctAnswer) {
                        showCelebration();
                        playSound('correct');
                    } else {
                        showEncouragement();
                        playSound('encouragement');
                    }
                });
            });
            
            quizQuestionsContainer.appendChild(questionElement);
            
            // 更新进度条
            const progress = ((questionIndex + 1) / appState.quizQuestions.length) * 100;
            quizProgress.style.width = `${progress}%`;
            
            // 更新按钮状态
            prevQuestionBtn.style.display = questionIndex > 0 ? 'flex' : 'none';
            
            if (questionIndex < appState.quizQuestions.length - 1) {
                nextQuestionBtn.style.display = 'flex';
                submitQuizBtn.style.display = 'none';
            } else {
                nextQuestionBtn.style.display = 'none';
                submitQuizBtn.style.display = 'flex';
            }
            
            // 隐藏反馈容器
            celebrationContainer.style.display = 'none';
            encouragementContainer.style.display = 'none';
        }

        // 显示庆祝动画
        function showCelebration() {
            const celebrations = [
                { emoji: '🎉', text: '太棒了！' },
                { emoji: '🌟', text: '做得好！' },
                { emoji: '👍', text: '真聪明！' },
                { emoji: '💪', text: '继续加油！' },
                { emoji: '👏', text: '太厉害了！' },
                { emoji: '✅', text: '答对了！' },
                { emoji: '🏆', text: '干得漂亮！' },
                { emoji: '⭐', text: '你真优秀！' }
            ];
            
            const celebration = celebrations[Math.floor(Math.random() * celebrations.length)];
            
            celebrationContainer.innerHTML = `
                <div class="celebration-animation">${celebration.emoji}</div>
                <div class="celebration-text">${celebration.text}</div>
            `;
            
            celebrationContainer.style.display = 'block';
            playSound('celebration');
            
            // 3秒后自动隐藏庆祝动画
            setTimeout(() => {
                celebrationContainer.style.display = 'none';
            }, 3000);
        }

        // 显示鼓励信息
        function showEncouragement() {
            const encouragements = [
                { emoji: '🤔', text: '再试一次！' },
                { emoji: '💡', text: '再想一想！' },
                { emoji: '🌱', text: '每次尝试都在进步！' },
                { emoji: '🚀', text: '继续努力！' },
                { emoji: '🌈', text: '下次会更好！' },
                { emoji: '📚', text: '学习需要时间！' },
                { emoji: '🧠', text: '大脑在成长！' },
                { emoji: '❤️', text: '你已经很棒了！' }
            ];
            
            const encouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
            
            encouragementContainer.innerHTML = `
                <div class="encouragement-animation">${encouragement.emoji}</div>
                <div class="encouragement-text">${encouragement.text}</div>
            `;
            
            encouragementContainer.style.display = 'block';
            playSound('encouragement');
            
            // 3秒后自动隐藏鼓励信息
            setTimeout(() => {
                encouragementContainer.style.display = 'none';
            }, 3000);
        }

        // 显示上一题
        function showPreviousQuestion() {
            if (appState.currentQuestion > 0) {
                showQuestion(appState.currentQuestion - 1);
                playSound('click');
            }
        }

        // 显示下一题
        function showNextQuestion() {
            if (appState.currentQuestion < appState.quizQuestions.length - 1) {
                showQuestion(appState.currentQuestion + 1);
                playSound('click');
            }
        }

        // 提交测试
        function submitQuiz() {
            // 记录结束时间
            appState.endTime = new Date();
            
            // 停止计时器
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
            }
            
            // 计算分数
            appState.score = 0;
            appState.wordPerformance = {};
            
            appState.quizQuestions.forEach((question, index) => {
                const isCorrect = appState.userAnswers[index] === question.correctAnswer;
                if (isCorrect) {
                    appState.score++;
                }
                appState.wordPerformance[question.word] = isCorrect;
            });
            
            // 显示结果
            showResults();
            playSound('complete');
        }

        // 显示结果
        function showResults() {
            showSection('results');
            
            finalScore.textContent = `${appState.score}/${appState.quizQuestions.length}`;
            
            const percentage = (appState.score / appState.quizQuestions.length) * 100;
            if (percentage >= 80) {
                resultFeedback.textContent = '太棒了！你已经完全掌握了这些单词！';
            } else if (percentage >= 60) {
                resultFeedback.textContent = '做得不错！再多练习一下会更好！';
            } else {
                resultFeedback.textContent = '继续努力，你可以做得更好！';
            }
            
            // 隐藏退出按钮
            exitBtn.style.display = 'none';
        }

        // 显示学情分析
        function showAnalysis() {
            showSection('analysis');
            
            // 计算学习时长（分钟）
            const learningTime = Math.round((appState.endTime - appState.startTime) / 1000 / 60);
            
            // 计算正确率
            const accuracy = Math.round((appState.score / appState.quizQuestions.length) * 100);
            
            // 计算未掌握单词数量
            const incorrectWords = Object.values(appState.wordPerformance).filter(val => !val).length;
            
            // 更新单词掌握情况列表
            wordMasteryList.innerHTML = '';
            appState.targetWords.forEach(word => {
                const isCorrect = appState.wordPerformance[word];
                const li = document.createElement('li');
                li.innerHTML = `
                    ${word} (${appState.wordDefinitions[word].chinese})
                    <span class="word-status ${isCorrect ? 'correct' : 'incorrect'}">
                        ${isCorrect ? '✓ 已掌握' : '✗ 需复习'}
                    </span>
                `;
                wordMasteryList.appendChild(li);
            });
            
            // 更新统计数据
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${learningTime}</div>
                    <div class="stat-label">学习时长(分钟)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${appState.quizQuestions.length}</div>
                    <div class="stat-label">测试题目</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${accuracy}%</div>
                    <div class="stat-label">正确率</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${incorrectWords}</div>
                    <div class="stat-label">需复习单词</div>
                </div>
            `;
            
            // 更新学习建议
            let recommendationText = '';
            if (accuracy >= 80) {
                recommendationText = `
                    <p>您的表现非常出色！已经掌握了大部分单词。</p>
                    <p>建议：继续保持，可以尝试挑战更高级别的单词。</p>
                `;
            } else if (accuracy >= 60) {
                recommendationText = `
                    <p>您的表现良好，但还有一些提升空间。</p>
                    <p>建议：重点复习未掌握的单词，多做练习巩固记忆。</p>
                `;
            } else {
                recommendationText = `
                    <p>您需要更多练习来掌握这些单词。</p>
                    <p>建议：重新学习故事内容，重点关注单词在情境中的用法，然后再次尝试测试。</p>
                `;
            }
            
            recommendations.innerHTML = `
                <h4>个性化学习建议</h4>
                ${recommendationText}
                <p>根据您的学习数据，我们建议您：</p>
                <ul>
                    <li>每天花15分钟复习单词</li>
                    <li>尝试使用单词造句，加深理解</li>
                    <li>定期回顾学习过的内容</li>
                </ul>
            `;
            
            playSound('page');
        }

        // 退出学习
        function exitLearning() {
            if (confirm('确定要退出学习吗？您的进度将不会保存。')) {
                playSound('click');
                restartApp();
            }
        }

        // 重新开始应用
        function restartApp() {
            // 停止计时器
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
            }
            
            // 重置应用状态
            appState.currentSection = 'upload';
            appState.targetWords = [];
            appState.wordDefinitions = {};
            appState.storyParts = [];
            appState.currentPart = 0;
            appState.quizQuestions = [];
            appState.currentQuestion = 0;
            appState.userAnswers = [];
            appState.score = 0;
            appState.timeLeft = 60;
            appState.timerInterval = null;
            appState.startTime = null;
            appState.endTime = null;
            appState.wordPerformance = {};
            
            // 重置UI
            fileInput.value = '';
            storyProgress.style.width = '0%';
            quizProgress.style.width = '0%';
            timeBar.style.width = '100%';
            exitBtn.style.display = 'none';
            
            // 显示上传部分
            showSection('upload');
        }

        // 工具函数：打乱数组顺序
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>